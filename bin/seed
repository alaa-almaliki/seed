#!/bin/bash

set -e

path="$(realpath "$(dirname "$(dirname "${BASH_SOURCE[0]}")")")"

# Set paths
if [ "$1" = 'set:path' ]; then
  if [ -f ~/.zshrc ]; then
     if ! grep -q "$path" ~/.zshrc; then
           echo "export PATH=\"$path/bin:\$PATH"\" | tee -a ~/.zshrc
           sleep 1
           source "$HOME"/.zshrc
     fi
  fi
  exit 1
fi

# build docker container
if [ "$1" = 'build' ]; then
    "$path"/bin/build
    exit 1
fi

# rebuild docker container from scratch
if [ "$1" = 'rebuild' ]; then
    "$path"/bin/destroy && "$path"/bin/build --no-cache
    exit 1
fi

# start docker container
if [ "$1" = 'up' ]; then
    "$path"/bin/up
    exit 1
fi

# stop docker container
if [ "$1" = 'stop' ]; then
    "$path"/bin/stop
    exit 1
fi

# restart docker container
if [ "$1" = 'restart' ]; then
    "$path"/bin/restart
    exit 1
fi

# destroy docker container
if [ "$1" = 'destroy' ]; then
    "$path"/bin/destroy
    exit 1
fi

# changes filesystem ownership
if [ "$1" = 'chown' ]; then
  "$path"/bin/exec chown -R root /var/www/html
  exit 1
fi

# ssh into the container
if [ "$1" = 'ssh' ]; then
    "$path"/bin/exec bash
    exit 1
fi

# Access mysql
if [ "$1" = 'mysql' ]; then
    "$path"/bin/exec mysql
    exit 1
fi

# Copy files from Container to host
# i.e /var/www/html/vendor to code/vendor
if [ "$1" = 'copy_from_container' ]; then
    "$path"/bin/cp host "$2"
    exit 1
fi

# Copy files to Container from host
# i.e code/vendor to /var/www/html/vendor
if [ "$1" = 'copy_to_container' ]; then
    "$path"/bin/cp container "$2"
    exit 1
fi

# Add root to container ip
if [ "$1" = 'host:mysql' ]; then
    "$path"/bin/exec mysql -e "GRANT USAGE ON *.* to root@${CONTAINER_IP} IDENTIFIED BY 'root';"
    sleep 1
    "$path"/bin/exec mysql -e "GRANT ALL PRIVILEGES ON *.* TO root@${CONTAINER_IP} WITH GRANT OPTION;"
    sleep 1
    "$path"/bin/exec mysql -e "FLUSH PRIVILEGES;"
    exit 1
fi

# run composer
if [ "$1" = 'composer' ]; then
  "$path"/bin/exec "$@"
  exit 1
fi

# run profiles commands
if [ "$1" = 'profiles' ]; then
    "$path"/bin/exec php seed "$@"
    exit 1
fi


if [ -z "$1" ]; then
  "$path"/bin/exec php seed seed -h
  exit 1
fi

if [ -f "$1" ]; then
    file=$(realpath "$1")
    file_basename=$(basename "$file")
    destination="$path/code/db/$file_basename"
fi

# exit if sql file is not provided
if [ ! -f "$file" ]; then
  echo -e "Please provide a dump file"
  exit 1
fi

# start seed
if [ -f "$file" ]; then
  if [ "$file" != "$destination" ]; then
    echo -e "Copying $file to $destination"
    /bin/cp "$file" "$destination"
    sleep 2
  fi
  
  "$path"/bin/exec php seed seed "$@"
fi